import{u as t,an as e,p as s,ao as i,a1 as a,d as o,V as n}from"./icon-alert-BG5stABd.js";class r{constructor({key:t,title:e,url:s,pinned:i,index:a}){this.type=w.Tab,this.key=t,this.title=e,this.url=s,this.pinned=i,this.index=a}}class d{constructor({key:t,tabs:e,index:s,color:i="grey",title:a="",collapsed:o=!1,manifestVersion:n}){this.type=w.Group,this.key=t,this.index=s,this.tabs=e.map((t=>new r(t))).sort(((t,e)=>t.index-e.index)),this.color=i,this.title=a,this.collapsed=o,this.manifestVersion=n||2}}var w=(t=>(t.Tab="Tab",t.Group="Group",t))(w||{});const l=["app","devtools"];class c{constructor({key:t,activeTabKey:e,state:s,type:i,left:a,top:o,width:n,height:w,browserSessionKey:l,tabsAndGroups:c}){this.tabsAndGroups=[],this.key=t,this.activeTabKey=e,this.state=s,this.type=i,this.left=a,this.top=o,this.width=n,this.height=w,l&&(this.browserSessionKey=l),this.tabsAndGroups=c.map((t=>"tabs"in t?new d(t):new r(t))).sort(((t,e)=>t.index-e.index))}get tabCount(){let t=0;return this.tabsAndGroups.forEach((e=>{t+=e instanceof r?1:e.tabs.length})),t}}const u=t=>{if(void 0!==t.id&&void 0!==t.state&&void 0!==t.type&&"app"!==t.type&&"devtools"!==t.type)return{key:t.id,state:t.state,type:t.type,left:t.left||0,top:t.top||0,width:t.width||window.outerWidth,height:t.height||window.outerHeight}};class h{constructor({id:t,name:e,windows:s,activeWindowKey:i,browser:a,dateCreated:o}){this.windows=[],this.id=t,this.name=e,this.windows=s.map((t=>new c(t))),this.activeWindowKey=i,this.browser=a,this.dateCreated=o}get totalTabCount(){return this.windows.map((t=>t.tabCount)).reduce(((t,e)=>t+e))}get displayName(){return this.name||t.getFriendlyDateTime(new Date(this.dateCreated))}get sessionDescriptionTabs(){const t=this.totalTabCount;return`${t} tab${t>1?"s":""}`}get sessionDescriptionWindows(){return`${this.windows.length} window${this.windows.length>1?"s":""}`}}var p=(t=>(t.List="list",t.Detail="detail",t))(p||{});const b=["tabs","sessions"],f=["tabs","sessions","tabGroups"],y={ERROR_STASH:"Oops, we couldn't save that session at this time.",ERROR_RESTORE:"Oops, we couldn't restore that session at this time.",ERROR_NO_OTHER_TABS:"No tabs to stash.",ERROR_DELETE:"Oops, there was a problem deleting that session.",ERROR_ALL_DELETE:"Oops, there was a problem deleting all sessions.",SUCCESSFUL_STASH_PARTIAL:" saved to a new session.",SUCCESSFUL_RESTORE_PARTIAL:" session restored.",SUCCESSFUL_ALL_DELETE:"All session deleted.",DELETE_PARTIAL:" session deleted."},g="chrome://newtab/",v="https://get.momentumdash.help/hc/en-us/articles/14474141114391";class S{constructor(t){this.dataService=t}get(t){this.dataService.get(t)}create(t){return this.dataService.create(t.id,t)}update(t,e,s={}){return this.dataService.update(t,e,s)}delete(t){return this.dataService.delete(t)}async ensurePermissions(t=!1){const i=e()?b:f;return!!(await s.permissions.contains({permissions:i}))||new Promise((e=>{m.cmd("modal.open","PERMISSION_REQUEST",{widgetName:"Tab Stash",permissionExplanation:"To save your tabs for later",permissions:{permissions:i},requestImmediately:t,resolve:e})}))}async closeWindowsAndSetSessionIds(t){var e;for(const a of t.windows)try{if(1===a.tabsAndGroups.length&&(null==(e=a.tabsAndGroups[0])?void 0:e.type)===w.Tab&&a.tabsAndGroups[0].url===g)await s.windows.remove(a.key);else{await s.windows.removeAndWaitForSessionChange(a.key);const t=await s.sessions.getLastClosedSessionId();t&&(a.browserSessionKey=t)}}catch(i){console.warn(i)}return t}async restoreSession(t){const e=t.windows.filter((e=>e.key!==t.activeWindowKey)),i=t.windows.filter((e=>e.key===t.activeWindowKey)),a=await s.tabs.query({currentWindow:!0}),o=a.find((t=>t.active));if(!o||!o.id)throw new Error("Could not find active tab id from current window");let n=o.windowId;for(const r of[...e,...i]){const e=await this.restoreWindow(r,t.browser);r.key===t.activeWindowKey&&1===a.length&&e.id&&(o.pinned&&await s.tabs.update(o.id,{pinned:!1}),await s.tabs.moveToWindow(o.id,e.id),n=e.id,o.pinned&&await s.tabs.update(o.id,{pinned:!0}))}await this.focusTabAndWindow(o.id,n)}async getSessionFromWindows(){var e;const a=await s.tabs.query({currentWindow:!0}),o=await s.tabs.getCurrent();let n=-1;o&&1!==a.length&&o.id&&(await this.pullTabInNewWindow(o),n=o.windowId);const r={id:t.uuidv4(),name:"",windows:[],activeWindowKey:n,browser:i(),dateCreated:(new Date).toISOString()},d=await s.windows.getAll(),w=null==(e=await s.windows.getCurrent())?void 0:e.id;for(const t of d){if(w===t.id||t.type&&l.includes(t.type))continue;const e=u(t);if(!e)throw new Error(`window returned by browser (${r.browser}) does not satisfy IWindow type`);const s=await this.setTabsDataForWindow(e,r.browser);r.windows.push(s)}return new h(r)}async openPartialSession(t){t instanceof c?await this.fallbackRestoreWindow(t,i()):t instanceof d?await this.createGroup(t):t instanceof r&&await s.tabs.create({url:t.url,pinned:t.pinned})}async createGroup(t){const e=[];for(const i of t.tabs){const t=await s.tabs.create({url:i.url,pinned:i.pinned});t.id&&e.push(t.id)}if(void 0!==chrome.tabs.group){const i=await s.tabs.group({tabIds:e});if(chrome.tabGroups&&3===t.manifestVersion){const{color:e,collapsed:s,title:a}=t;await chrome.tabGroups.update(i,{color:e,collapsed:s,title:a})}}}async pullTabInNewWindow(t){const e=t.id;if(!e)throw new Error("Could not read tab id when pulling out tab from window");const i=await s.windows.get(t.windowId),a={left:i.left,top:i.top,width:i.width,height:i.height};let o;if("normal"===i.state&&(o=await s.windows.create({tabId:e,...a})),o||(o=await s.windows.create({tabId:e})),!o)throw new Error("Could not create window when pulling out tab from window");t.pinned&&await s.tabs.update(e,{pinned:!0})}async setTabsDataForWindow(t,e){var i;const a=await s.tabs.query({windowId:t.key}),o=a.map((t=>{const s=(t=>{if(void 0!==t.id&&void 0!==t.url)return{key:t.id,title:t.title||"",url:t.url,pinned:t.pinned,index:t.index,type:w.Tab}})(t);if(!s)throw new Error(`tab returned by browser (${e})could not be converted to ITab`);return s})).sort(((t,e)=>t.index-e.index)),n=[];for(let s=0;s<o.length;s++){const t=o[s],e=a[s];if(t&&e)if(~e.groupId&&void 0!==e.groupId){const t=a.filter((t=>t.groupId===e.groupId)).length;let i={};if(chrome&&chrome.tabGroups){const t=await chrome.tabGroups.get(e.groupId),{color:s,collapsed:a,title:o=""}=t;i={color:s,collapsed:a,title:o,manifestVersion:3}}const r={key:e.groupId,index:s,type:w.Group,tabs:o.slice(s,s+t),...i};s+=t-1,n.push(r)}else n.push(t)}return{...t,activeTabKey:(null==(i=a.find((t=>t.active)))?void 0:i.id)||-1,tabsAndGroups:n}}async restoreWindow(t,e){const i=t.browserSessionKey;let a;return i&&(a=await s.sessions.restoreWindow(i)),a||(a=await this.fallbackRestoreWindow(t,e)),a}async fallbackRestoreWindow(t,e){var i,a,o,n,w;let c;const{tabsAndGroups:u,activeTabKey:h,key:p,browserSessionKey:b,...f}=t,y=u.map((t=>t instanceof r?[t]:t.tabs)).flat(),m={...f};if(m.type&&l.includes(m.type)&&(m.type="normal"),m.url=this.getUrlArrayForWindowCreateFromTabs(y,e),["maximized","minimized","fullscreen"].includes(t.state)){["width","height","left","top"].forEach((t=>delete m[t]))}if(c=await s.windows.create(m),!c){["left","top"].forEach((t=>delete m[t])),c=await s.windows.create(m)}if(!c){["width","height"].forEach((t=>delete m[t])),c=await s.windows.create(m)}if(!c)throw new Error("Could not create window");if(void 0!==chrome.tabs.group)for(const r of u){if(!(r instanceof d))continue;const t=r.index,e=t+r.tabs.length,a={tabIds:((null==(i=c.tabs)?void 0:i.slice(t,e))||[]).flatMap((t=>void 0===t.id?[]:[t.id])),createProperties:{windowId:c.id}},o=await s.tabs.group(a);if(chrome.tabGroups&&3===r.manifestVersion){const{color:t,collapsed:e,title:s}=r;await chrome.tabGroups.update(o,{color:t,collapsed:e,title:s})}}for(let r=0;r<y.length;r++){const t=y[r];if(null==t?void 0:t.pinned){const t=null==(o=null==(a=c.tabs)?void 0:a[r])?void 0:o.id;if(!t)continue;await s.tabs.update(t,{pinned:!0})}}const g=y.find((t=>t.key===h));if(g){const t=y.indexOf(g),e=null==(w=null==(n=c.tabs)?void 0:n[t])?void 0:w.id;e&&await s.tabs.update(e,{active:!0})}return c}getUrlArrayForWindowCreateFromTabs(e,s){const a=t=>t.startsWith(s+"-extension://")||t.startsWith(s+"://"),o=e.map((e=>e.url===g&&t.isFirefox()?"/index.html":a(e.url)?e.url.replace(s,i()):e.url)).filter((e=>!(a(e)&&t.isFirefox()||e.startsWith("about:"))));return 0===o.length&&o.push("/index.html"),o}async focusTabAndWindow(t,e){t&&await s.tabs.update(t,{active:!0}),e&&await s.windows.update(e,{focused:!0})}}const T=()=>({tabStashService:new S(new a("tabs"))}),E=(t=T().tabStashService)=>o("tabs",{state:()=>({data:{},loading:!1,loaded:!1,activeItemId:""}),getters:{getItems:t=>Object.values(t.data).map((t=>new h(t))).sort(((t,e)=>Date.parse(e.dateCreated)-Date.parse(t.dateCreated))),getItemById:t=>e=>{const s=t.data[e];return s?new h(s):null}},actions:{refresh(){this.loading=!0,t.get({success:t=>{t.forEach((t=>n.set(this.data,t.id,t))),this.loaded=!0,this.loading=!1}})},async stashSession(){if(!(await t.ensurePermissions()))return;const e=await t.getSessionFromWindows();return 0===e.windows.length||(await this.create(e),await t.closeWindowsAndSetSessionIds(e),await this.update(e.id,{windows:e.windows})),e},async restoreSession(e){if(await t.ensurePermissions())return await t.restoreSession(e),await this.delete(e.id),!0},async create(e){n.set(this.data,e.id,e),await t.create(e)},async delete(e){n.delete(this.data,e),await t.delete(e)},async update(e,s){const i=this.data[e];if(!i)throw new Error(`No data found for ${e}`);const a={...i,...s};n.set(this.data,e,a);const o=Object.keys(s).join(",");return await t.update(e,a,{queryParams:{update_mask:o}}),a},ensurePermissions:e=>t.ensurePermissions(e)}}),W=E(),I=Object.freeze(Object.defineProperty({__proto__:null,default:W,makeTabsStore:E,useTabsStore:W},Symbol.toStringTag,{value:"Module"}));export{d as G,v as H,h as S,p as T,c as W,r as a,w as b,y as m,T as p,I as t,W as u};